# 🔧 配置环境变量 - 解决缺失密钥问题

## ❌ 当前问题

健康检查显示缺少以下环境变量：
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - 未设置
- `SUPABASE_SERVICE_ROLE_KEY` - 未设置

## ✅ 解决步骤

### 步骤 1: 获取 Supabase 密钥

1. 打开 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单的 **Settings** (设置)
4. 点击 **API** 选项

你会看到以下信息：

#### Project URL
```
https://xxxxxxxxxxxxx.supabase.co
```
→ 这是你的 `NEXT_PUBLIC_SUPABASE_URL`

#### API Keys 部分

**anon public** key:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4eHh4eHh4eHh4eHh4eHh4eCIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNjQ1Nzg5MDAwLCJleHAiOjE5NjEzNjUwMDB9...
```
→ 这是你的 `NEXT_PUBLIC_SUPABASE_ANON_KEY`

**service_role** key (⚠️ 有警告标志，在页面底部):
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4eHh4eHh4eHh4eHh4eHh4eCIsInJvbGUiOiJzZXJ2aWNlX3JvbGUiLCJpYXQiOjE2NDU3ODkwMDAsImV4cCI6MTk2MTM2NTAwMH0...
```
→ 这是你的 `SUPABASE_SERVICE_ROLE_KEY` (非常重要！)

### 步骤 2: 创建 .env.local 文件

在项目根目录（与 `package.json` 同级）创建 `.env.local` 文件：

**Windows 用户：**
1. 在项目文件夹中右键点击
2. 选择 "新建" → "文本文档"
3. 重命名为 `.env.local` (注意：文件名以点开头)
4. 如果 Windows 提示"必须输入文件名"，可以：
   - 先创建 `env.local`
   - 然后在命令行运行：`ren env.local .env.local`

**或者使用命令行：**
```powershell
# 在项目根目录运行
New-Item -Path .env.local -ItemType File
```

**Mac/Linux 用户：**
```bash
touch .env.local
```

### 步骤 3: 填入密钥

打开 `.env.local` 文件，复制以下内容并填入你的实际值：

```env
# Supabase 项目 URL
NEXT_PUBLIC_SUPABASE_URL=https://你的项目ID.supabase.co

# Supabase Anon Key (公开密钥)
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的anon_key

# Supabase Service Role Key (服务端密钥，请保密！)
SUPABASE_SERVICE_ROLE_KEY=你的service_role_key
```

**示例：**
```env
NEXT_PUBLIC_SUPABASE_URL=https://abcdefghijklmnop.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTY0NTc4OTAwMCwiZXhwIjoxOTYxMzY1MDAwfQ...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNjQ1Nzg5MDAwLCJleHAiOjE5NjEzNjUwMDB9...
```

### 步骤 4: 保存文件

确保文件已保存。

### 步骤 5: 重启开发服务器

**重要：** 修改 `.env.local` 后必须重启服务器！

1. 停止当前运行的服务器（按 `Ctrl+C`）
2. 重新启动：
   ```bash
   npm run dev
   ```

### 步骤 6: 验证配置

访问健康检查端点：
```
http://localhost:3000/api/health
```

应该看到：
```json
{
  "envVars": {
    "supabaseUrl": true,
    "supabaseAnonKey": true,
    "supabaseServiceKey": true
  },
  "supabaseConnection": true,
  "databaseTables": {
    "leads": false,
    "enquiries": false,
    "enrolments": false
  },
  "errors": []
}
```

如果 `databaseTables` 仍然是 `false`，说明表还没有创建，需要运行 `fix-leads-permission.sql` 脚本。

## 🔍 常见问题

### Q: 找不到 service_role key？
A: 在 Supabase Dashboard → Settings → API 页面，向下滚动到底部，service_role key 通常在页面最下方，有一个警告标志。

### Q: 如何确认密钥是否正确？
A: 
- **anon key** 的 JWT payload 中应该包含 `"role":"anon"`
- **service_role key** 的 JWT payload 中应该包含 `"role":"service_role"`

你可以在 [jwt.io](https://jwt.io) 解码 JWT 来验证。

### Q: Windows 无法创建以点开头的文件？
A: 使用命令行：
```powershell
New-Item -Path .env.local -ItemType File -Force
```

或者先创建 `env.local`，然后在命令行重命名：
```powershell
ren env.local .env.local
```

### Q: 修改后仍然显示错误？
A: 
1. 确保文件名为 `.env.local`（不是 `.env.local.txt`）
2. 确保没有多余的空格或引号
3. 确保已重启开发服务器
4. 检查文件是否在项目根目录（与 `package.json` 同级）

## ⚠️ 安全提示

- **永远不要**将 `.env.local` 文件提交到 Git
- **永远不要**在公共场合分享你的 `SUPABASE_SERVICE_ROLE_KEY`
- Service Role Key 拥有完全的管理权限，请妥善保管
